<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KHS CRM Connection Debug</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; border: 1px solid #b8daff; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>KHS CRM Connection Debug Tool</h1>
    <p>This tool helps diagnose connection issues between your iPhone and the Railway server.</p>

    <div id="results"></div>

    <button onclick="runDiagnostics()">Run Full Diagnostics</button>
    <button onclick="testBasicConnectivity()">Test Basic Connectivity</button>
    <button onclick="testAuthFlow()">Test Authentication</button>
    <button onclick="clearResults()">Clear Results</button>

    <script>
        const RAILWAY_URL = 'https://khs-crm-2-production.up.railway.app';
        const results = document.getElementById('results');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            results.innerHTML = '';
        }

        async function testBasicConnectivity() {
            log('Testing basic connectivity to Railway server...', 'info');
            
            try {
                const response = await fetch(`${RAILWAY_URL}/api/health`, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Railway server is reachable! Status: ${data.status}`, 'success');
                    log(`<pre>${JSON.stringify(data, null, 2)}</pre>`, 'info');
                } else {
                    log(`‚ùå Railway server responded with error: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Failed to reach Railway server: ${error.message}`, 'error');
                
                // Additional network diagnostics
                if (error.name === 'TypeError' && error.message.includes('Network request failed')) {
                    log('This looks like a network connectivity issue. Possible causes:', 'info');
                    log('- No internet connection', 'info');
                    log('- Firewall blocking requests', 'info');
                    log('- Railway server is down', 'info');
                }
                
                if (error.name === 'TypeError' && error.message.includes('CORS')) {
                    log('This looks like a CORS (Cross-Origin) issue', 'error');
                    log('The server may not be configured to allow requests from this domain', 'info');
                }
            }
        }

        async function testAuthFlow() {
            log('Testing authentication flow...', 'info');
            
            try {
                const response = await fetch(`${RAILWAY_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@khscrm.com',
                        password: 'admin123'
                    }),
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ Authentication successful!', 'success');
                    
                    // Test authenticated request
                    const authResponse = await fetch(`${RAILWAY_URL}/api/auth/check`, {
                        headers: {
                            'Authorization': `Bearer ${data.token}`
                        },
                        mode: 'cors',
                        credentials: 'omit'
                    });
                    
                    if (authResponse.ok) {
                        log('‚úÖ Authenticated API call successful!', 'success');
                    } else {
                        log(`‚ùå Authenticated API call failed: ${authResponse.status}`, 'error');
                    }
                } else {
                    log(`‚ùå Authentication failed: ${response.status} ${response.statusText}`, 'error');
                    const errorData = await response.json().catch(() => ({}));
                    log(`Error details: ${JSON.stringify(errorData, null, 2)}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Authentication test failed: ${error.message}`, 'error');
            }
        }

        async function testServiceWorker() {
            log('Testing Service Worker status...', 'info');
            
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        log('‚úÖ Service Worker is registered', 'success');
                        log(`SW State: ${registration.active?.state || 'unknown'}`, 'info');
                        log(`SW Script URL: ${registration.active?.scriptURL || 'unknown'}`, 'info');
                        
                        // Test SW message communication
                        if (registration.active) {
                            registration.active.postMessage({
                                type: 'DEBUG_TEST',
                                railwayUrl: RAILWAY_URL
                            });
                        }
                    } else {
                        log('‚ùå No Service Worker registration found', 'error');
                    }
                } catch (error) {
                    log(`‚ùå Service Worker check failed: ${error.message}`, 'error');
                }
            } else {
                log('‚ùå Service Workers not supported', 'error');
            }
        }

        async function testEnvironmentInfo() {
            log('Collecting environment information...', 'info');
            
            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                connection: navigator.connection?.effectiveType || 'unknown',
                currentOrigin: window.location.origin,
                railwayUrl: RAILWAY_URL,
                isStandalone: window.matchMedia('(display-mode: standalone)').matches,
                isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
                isSafari: /^((?!chrome|android).)*safari/i.test(navigator.userAgent)
            };
            
            log(`<pre>${JSON.stringify(info, null, 2)}</pre>`, 'info');
            
            // iOS-specific checks
            if (info.isIOS) {
                log('üçé iOS device detected - checking for iOS-specific issues...', 'info');
                
                // Check if running as PWA
                if (info.isStandalone) {
                    log('üì± Running as installed PWA (standalone mode)', 'info');
                } else {
                    log('üåê Running in Safari browser', 'info');
                }
                
                // Check for localStorage availability
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                    log('‚úÖ localStorage is available', 'success');
                } catch (error) {
                    log('‚ùå localStorage is not available (possible private browsing)', 'error');
                }
            }
        }

        async function runDiagnostics() {
            clearResults();
            log('Starting comprehensive diagnostics...', 'info');
            
            await testEnvironmentInfo();
            await testBasicConnectivity();
            await testServiceWorker();
            await testAuthFlow();
            
            log('Diagnostics complete!', 'success');
        }

        // Listen for messages from service worker
        navigator.serviceWorker?.addEventListener('message', (event) => {
            if (event.data?.type === 'DEBUG_RESPONSE') {
                log(`SW Response: ${JSON.stringify(event.data.result, null, 2)}`, 'info');
            }
        });

        // Auto-run basic test on page load
        document.addEventListener('DOMContentLoaded', () => {
            log('Debug tool loaded. Click "Run Full Diagnostics" to start.', 'info');
        });
    </script>
</body>
</html>